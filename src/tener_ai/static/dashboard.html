<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tener.ai Pipeline Control Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0a0e14;
      --bg-card: #141921;
      --bg-hover: #1a1f2a;
      --accent-green: #00ff87;
      --accent-green-dim: rgba(0, 255, 135, 0.12);
      --accent-green-glow: rgba(0, 255, 135, 0.35);
      --accent-blue: #00d4ff;
      --accent-purple: #a855f7;
      --accent-red: #ef4444;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --border-color: #30363d;
      --ok: #10b981;
      --warn: #f59e0b;
      --err: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      font-family: 'DM Sans', sans-serif;
      color: var(--text-primary);
      background: radial-gradient(circle at 20% 20%, var(--accent-green-dim) 0%, transparent 45%),
                  radial-gradient(circle at 80% 10%, rgba(0, 212, 255, 0.08) 0%, transparent 35%),
                  var(--bg-dark);
      display: grid;
      grid-template-columns: 280px 1fr;
    }

    .sidebar {
      border-right: 1px solid var(--border-color);
      background: rgba(20, 25, 33, 0.95);
      padding: 26px 18px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .logo {
      font-family: 'Space Mono', monospace;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .logo span { color: var(--accent-green); }

    .subnote {
      color: var(--text-secondary);
      font-size: 13px;
      line-height: 1.4;
    }

    .nav-group {
      display: grid;
      gap: 8px;
    }

    .nav-item {
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text-secondary);
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-item .mono { font-family: 'Space Mono', monospace; font-size: 11px; }

    .main {
      padding: 24px;
      display: grid;
      gap: 16px;
      align-content: start;
    }

    .card {
      border: 1px solid var(--border-color);
      border-radius: 14px;
      background: var(--bg-card);
      padding: 16px;
    }

    .header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: center;
    }

    .title {
      font-family: 'Space Mono', monospace;
      font-size: 22px;
      line-height: 1.2;
      background: linear-gradient(135deg, var(--text-primary), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 6px;
    }

    .button-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .view-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .view-tab.active {
      border-color: var(--accent-green);
      color: var(--accent-green);
      box-shadow: 0 0 12px var(--accent-green-dim);
    }

    .view-section {
      display: none;
      gap: 16px;
      align-content: start;
    }

    .view-section.active { display: grid; }

    button {
      border: 1px solid var(--border-color);
      border-radius: 9px;
      padding: 10px 13px;
      background: var(--bg-hover);
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all .2s ease;
    }

    button:hover { border-color: var(--accent-green); }

    .btn-primary {
      background: var(--accent-green);
      color: #08120d;
      border-color: var(--accent-green);
      box-shadow: 0 0 20px var(--accent-green-glow);
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .metric .label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    .metric .value {
      margin-top: 4px;
      font-family: 'Space Mono', monospace;
      font-size: 26px;
      color: var(--accent-green);
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .form-grid .full { grid-column: span 2; }

    input, textarea, select {
      width: 100%;
      border: 1px solid var(--border-color);
      background: #0f141c;
      color: var(--text-primary);
      border-radius: 9px;
      padding: 10px 11px;
      font-family: 'DM Sans', sans-serif;
    }

    textarea { min-height: 84px; resize: vertical; }

    .steps {
      display: grid;
      grid-template-columns: repeat(6, minmax(190px, 1fr));
      gap: 10px;
    }

    .step-card {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px;
      background: #111722;
      display: grid;
      gap: 10px;
    }

    .step-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 14px;
    }

    .status {
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .status.running { color: var(--warn); border-color: var(--warn); }
    .status.success { color: var(--ok); border-color: var(--ok); }
    .status.error { color: var(--err); border-color: var(--err); }

    .step-metrics {
      color: var(--text-secondary);
      font-size: 13px;
      line-height: 1.5;
      min-height: 58px;
    }

    .step-actions { display: flex; gap: 8px; }
    .step-actions button { flex: 1; font-size: 12px; padding: 9px; }
    .json-nav { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
    .json-tab { font-size: 11px; padding: 7px 9px; }
    .json-tab.active { border-color: var(--accent-green); color: var(--accent-green); }

    .panels {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 12px;
    }

    .agent-layout {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 12px;
    }

    .chat-window {
      max-height: 420px;
      overflow: auto;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px;
      background: #0f141c;
      display: grid;
      gap: 8px;
    }

    .chat-msg {
      border: 1px solid #2a3441;
      border-radius: 10px;
      padding: 8px;
    }

    .chat-msg.inbound { border-color: #31506b; }
    .chat-msg.outbound { border-color: #2a6b52; }
    .row-selected { outline: 1px solid var(--accent-green); outline-offset: -1px; }

    .panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-weight: 700;
      font-size: 14px;
    }

    .mono { font-family: 'Space Mono', monospace; }

    .log-box {
      max-height: 300px;
      overflow: auto;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px;
      background: #0f141c;
      font-size: 12px;
      display: grid;
      gap: 8px;
    }

    .log-row {
      border-bottom: 1px dashed #2a3441;
      padding-bottom: 8px;
    }

    .log-row:last-child { border-bottom: none; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      border-bottom: 1px solid #242d3b;
      padding: 9px 8px;
      text-align: left;
      vertical-align: top;
    }

    th {
      color: var(--text-secondary);
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      letter-spacing: .04em;
      text-transform: uppercase;
      background: #101722;
    }

    .muted { color: var(--text-secondary); }

    .verify-list {
      display: grid;
      gap: 8px;
      max-height: 240px;
      overflow: auto;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: #0f141c;
      padding: 10px;
    }

    .verify-item {
      border-bottom: 1px dashed #2a3441;
      padding-bottom: 8px;
    }

    .verify-item:last-child { border-bottom: none; }

    .pill {
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      display: inline-block;
    }

    .pill.verified { color: var(--ok); border-color: var(--ok); }
    .pill.needs_resume { color: var(--warn); border-color: var(--warn); }
    .pill.rejected { color: var(--err); border-color: var(--err); }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      z-index: 50;
      padding: 16px;
    }

    .modal.open { display: grid; }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(2, 6, 11, 0.8);
      backdrop-filter: blur(2px);
    }

    .modal-card {
      position: relative;
      width: min(840px, 100%);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      background: var(--bg-card);
      padding: 16px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    }

    @media (max-width: 1240px) {
      body { grid-template-columns: 1fr; }
      .sidebar { position: relative; height: auto; }
      .controls, .panels { grid-template-columns: 1fr; }
      .steps { grid-template-columns: 1fr 1fr; }
      .agent-layout { grid-template-columns: 1fr; }
    }

    @media (max-width: 760px) {
      .main { padding: 14px; }
      .steps { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .form-grid .full { grid-column: span 1; }
      .grid-3 { grid-template-columns: 1fr; }
      .header { grid-template-columns: 1fr; }
      .button-row { justify-content: flex-start; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="logo">Tener<span>.ai</span></div>
      <p class="subnote">Pipeline Control Center<br>Manual orchestration + live diagnostics</p>
    </div>

    <div class="nav-group">
      <div class="nav-item"><span>Source</span><span class="mono" id="nav-source">idle</span></div>
      <div class="nav-item"><span>Enrich</span><span class="mono" id="nav-enrich">idle</span></div>
      <div class="nav-item"><span>Verify</span><span class="mono" id="nav-verify">idle</span></div>
      <div class="nav-item"><span>Add</span><span class="mono" id="nav-add">idle</span></div>
      <div class="nav-item"><span>Outreach</span><span class="mono" id="nav-outreach">idle</span></div>
      <div class="nav-item"><span>FAQ</span><span class="mono" id="nav-faq">idle</span></div>
    </div>

    <div class="card">
      <div class="panel-title"><span>Current Job</span><span class="mono" id="job-label">none</span></div>
      <div class="muted" id="job-meta">Create or select a job to begin.</div>
    </div>
  </aside>

  <main class="main">
    <section class="card header">
      <div>
        <h1 class="title">Manual Hiring Pipeline Dashboard</h1>
        <p class="subtitle">Run each step independently, inspect outputs, and monitor logs in real time.</p>
      </div>
      <div class="button-row">
        <button id="open-create-modal-btn">Create Job</button>
        <button id="refresh-btn">Refresh Data</button>
        <button class="btn-primary" id="run-full-btn">Run Full Pipeline</button>
      </div>
    </section>

    <section class="card">
      <div class="view-tabs">
        <button id="view-tab-pipeline" class="view-tab active">Pipeline</button>
        <button id="view-tab-agent" class="view-tab">Recruiter Agent</button>
      </div>
    </section>

    <section id="view-pipeline" class="view-section active">
    <section class="grid-3">
      <div class="card metric">
        <div class="label">Searched</div>
        <div class="value" id="metric-searched">0</div>
      </div>
      <div class="card metric">
        <div class="label">Verified</div>
        <div class="value" id="metric-verified">0</div>
      </div>
      <div class="card metric">
        <div class="label">Outreached</div>
        <div class="value" id="metric-outreached">0</div>
      </div>
    </section>

    <section class="controls">
      <div class="card">
        <div class="panel-title"><span>Select Job</span><span class="mono">GET /api/jobs</span></div>
        <div class="form-grid">
          <div class="full">
            <label class="muted">Job</label>
            <select id="job-select"></select>
          </div>
          <div>
            <label class="muted">Source Limit</label>
            <input id="source-limit" type="number" value="10" min="1" max="100">
          </div>
          <div>
            <label class="muted">Logs Limit</label>
            <input id="logs-limit" type="number" value="60" min="1" max="500">
          </div>
          <div class="full">
            <label class="muted" style="display:flex;align-items:center;gap:10px;">
              <input id="test-mode-toggle" type="checkbox" checked>
              <span>Test mode: source + outreach only forced test accounts</span>
            </label>
          </div>
        </div>
      </div>
    </section>

    <section class="steps">
      <article class="step-card">
        <div class="step-title"><span>1. Source</span><span id="status-source" class="status">idle</span></div>
        <div id="step-source-meta" class="step-metrics">Profiles: 0</div>
        <div class="step-actions">
          <button id="run-source-btn">Run</button>
        </div>
      </article>

      <article class="step-card">
        <div class="step-title"><span>2. Enrich</span><span id="status-enrich" class="status">idle</span></div>
        <div id="step-enrich-meta" class="step-metrics">Profiles: 0, Failed: 0</div>
        <div class="step-actions">
          <button id="run-enrich-btn">Run</button>
        </div>
      </article>

      <article class="step-card">
        <div class="step-title"><span>3. Verify</span><span id="status-verify" class="status">idle</span></div>
        <div id="step-verify-meta" class="step-metrics">Verified: 0, Needs resume: 0, Rejected: 0</div>
        <div class="step-actions">
          <button id="run-verify-btn">Run</button>
        </div>
      </article>

      <article class="step-card">
        <div class="step-title"><span>4. Add</span><span id="status-add" class="status">idle</span></div>
        <div id="step-add-meta" class="step-metrics">Added: 0</div>
        <div class="step-actions">
          <button id="run-add-btn">Run</button>
        </div>
      </article>

      <article class="step-card">
        <div class="step-title"><span>5. Outreach</span><span id="status-outreach" class="status">idle</span></div>
        <div id="step-outreach-meta" class="step-metrics">Total: 0, Sent: 0, Pending: 0, Failed: 0</div>
        <div class="step-actions">
          <button id="run-outreach-btn">Run</button>
          <button id="poll-connections-btn">Poll</button>
        </div>
      </article>

      <article class="step-card">
        <div class="step-title"><span>6. FAQ</span><span id="status-faq" class="status">manual</span></div>
        <div class="step-metrics">Inbound auto-replies are triggered via conversation endpoint.</div>
        <div class="step-actions">
          <button disabled>Use API</button>
        </div>
      </article>
    </section>

    <section class="card">
      <div class="panel-title"><span>Verification Explanations</span><span class="mono">rules-based</span></div>
      <div id="verify-explanations-box" class="verify-list">
        <div class="muted">Run Verify to see human-readable decision reasons.</div>
      </div>
    </section>

    <section class="panels">
      <div class="card">
        <div class="panel-title"><span>Live Operation Logs</span><button id="logs-refresh-btn">Reload</button></div>
        <div id="logs-box" class="log-box"></div>
      </div>

      <div class="card">
        <div class="panel-title"><span>Step JSON Outputs</span><span class="mono" id="snapshot-label">none</span></div>
        <div class="json-nav">
          <button class="json-tab" data-step="source" data-label="source">source</button>
          <button class="json-tab" data-step="enrich" data-label="enrich">enrich</button>
          <button class="json-tab" data-step="verify" data-label="verify">verify</button>
          <button class="json-tab" data-step="add" data-label="add">add</button>
          <button class="json-tab" data-step="outreach" data-label="outreach">outreach</button>
          <button class="json-tab" data-step="workflow" data-label="workflow">workflow</button>
        </div>
        <div id="snapshot-box" class="log-box"></div>
      </div>
    </section>

    <section class="card">
      <div class="panel-title"><span>Candidates for Selected Job</span><button id="cands-refresh-btn">Reload</button></div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Status</th>
              <th>Score</th>
              <th>Location</th>
              <th>Skills</th>
            </tr>
          </thead>
          <tbody id="candidates-tbody"></tbody>
        </table>
      </div>
    </section>
    </section>

    <section id="view-agent" class="view-section">
      <section class="card">
        <div class="panel-title">
          <span>Recruiter Agent: <span class="mono">pre_resume</span></span>
          <span class="mono" id="agent-job-title">no job selected</span>
        </div>
        <div class="form-grid">
          <div class="full">
            <label class="muted">Job</label>
            <select id="agent-job-select"></select>
          </div>
          <div class="full">
            <label class="muted">JD Description (agent context)</label>
            <textarea id="agent-jd-text" placeholder="Paste job description here..."></textarea>
          </div>
          <div class="full button-row" style="justify-content:flex-start;">
            <button id="agent-save-jd-btn">Save JD</button>
            <button id="agent-refresh-accounts-btn">Refresh Accounts</button>
          </div>
        </div>
      </section>

      <section class="agent-layout">
        <div class="card">
          <div class="panel-title"><span>Accounts In Active Communication</span><span class="mono">GET /api/chats/overview</span></div>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Conversation</th>
                  <th>Candidate</th>
                  <th>Source</th>
                  <th>Pre-resume</th>
                  <th>Last Message</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="agent-accounts-tbody">
                <tr><td colspan="6" class="muted">Select job</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="panel-title"><span>Add Manual Account (test)</span><span class="mono">POST /api/agent/accounts/manual</span></div>
          <div class="form-grid">
            <div>
              <label class="muted">Candidate Name</label>
              <input id="agent-manual-name" placeholder="Test Candidate">
            </div>
            <div>
              <label class="muted">Language</label>
              <input id="agent-manual-language" value="en" placeholder="en">
            </div>
            <div>
              <label class="muted">LinkedIn ID (optional)</label>
              <input id="agent-manual-linkedin-id" placeholder="manual-linkedin-id">
            </div>
            <div>
              <label class="muted">External Chat ID (optional)</label>
              <input id="agent-manual-chat-id" placeholder="manual-chat-1">
            </div>
            <div class="full button-row" style="justify-content:flex-start;">
              <button id="agent-add-manual-btn">Add Account</button>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="panel-title"><span>Agent Chat Simulator</span><span class="mono" id="agent-chat-title">No conversation selected</span></div>
        <div id="agent-chat-messages" class="chat-window">
          <div class="muted">Open any account to see dialogue.</div>
        </div>
        <div class="form-grid" style="margin-top:10px;">
          <div class="full">
            <label class="muted">Candidate inbound message</label>
            <textarea id="agent-inbound-input" placeholder="Type candidate reply and send to agent..."></textarea>
          </div>
          <div class="full button-row" style="justify-content:flex-start;">
            <button id="agent-send-inbound-btn">Send Candidate Message</button>
            <button id="agent-refresh-chat-btn">Reload Chat</button>
          </div>
        </div>
      </section>
    </section>
  </main>

  <div id="create-job-modal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" id="create-job-modal-backdrop"></div>
    <section class="modal-card">
      <div class="panel-title">
        <span>Create Job</span>
        <button id="close-create-modal-btn">Close</button>
      </div>
      <div class="form-grid">
        <div>
          <label class="muted">Title</label>
          <input id="job-title" placeholder="Senior Backend Engineer">
        </div>
        <div>
          <label class="muted">Location</label>
          <input id="job-location" placeholder="Germany / Remote">
        </div>
        <div>
          <label class="muted">Seniority</label>
          <select id="job-seniority">
            <option value="">auto</option>
            <option value="junior">junior</option>
            <option value="middle">middle</option>
            <option value="senior">senior</option>
            <option value="lead">lead</option>
          </select>
        </div>
        <div>
          <label class="muted">Preferred Languages (comma)</label>
          <input id="job-languages" placeholder="en, ru">
        </div>
        <div class="full">
          <label class="muted">JD Text</label>
          <textarea id="job-jd" placeholder="Need Python, Django, AWS, Docker, PostgreSQL..."></textarea>
        </div>
        <div class="full button-row" style="justify-content:flex-start;">
          <button class="btn-primary" id="create-job-btn">Create Job</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    function defaultStepSnapshots() {
      return {
        source: null,
        enrich: null,
        verify: null,
        add: null,
        outreach: null,
        workflow: null
      };
    }

    const SELECTED_JOB_STORAGE_KEY = "tener.selectedJobId";
    const TEST_MODE_STORAGE_KEY = "tener.testMode";
    const PIPELINE_STEPS = ["source", "enrich", "verify", "add", "outreach"];

    const state = {
      jobId: null,
      testMode: true,
      activeView: "pipeline",
      sourceProfiles: [],
      enrichedProfiles: [],
      verifyItems: [],
      addedCandidates: [],
      outreachItems: [],
      agentAccounts: [],
      agentConversationId: null,
      selectedSnapshotStep: "source",
      stepSnapshots: defaultStepSnapshots()
    };

    const $ = (id) => document.getElementById(id);
    const DEFAULT_JOB_TEMPLATE = {
      title: "Senior Backend Engineer",
      location: "Germany",
      seniority: "senior",
      preferred_languages: "en",
      jd_text: "Need Python, Django, AWS, Docker, PostgreSQL for backend microservices."
    };

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        ...opts,
        headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) }
      });
      const rawText = await res.text();
      let data = {};
      if (rawText) {
        try {
          data = JSON.parse(rawText);
        } catch {
          data = { raw_text: rawText };
        }
      }
      if (!res.ok) {
        const detail = [
          typeof data.error === 'string' ? data.error : '',
          typeof data.details === 'string' ? data.details : '',
          typeof data.message === 'string' ? data.message : '',
          typeof data.raw_text === 'string' ? data.raw_text : ''
        ].find((x) => String(x || '').trim());
        const fallback = `${res.status} ${res.statusText || 'Request failed'}`.trim();
        throw new Error(detail ? `HTTP ${res.status}: ${detail}` : fallback);
      }
      return data;
    }

    function setStepStatus(step, status) {
      const el = $("status-" + step);
      el.className = "status";
      if (status === "running") el.classList.add("running");
      if (status === "success") el.classList.add("success");
      if (status === "error") el.classList.add("error");
      el.textContent = status;

      const nav = $("nav-" + step);
      if (nav) nav.textContent = status;
    }

    function setMetrics({searched = 0, verified = 0, outreached = 0}) {
      $("metric-searched").textContent = searched;
      $("metric-verified").textContent = verified;
      $("metric-outreached").textContent = outreached;
    }

    function snapshot(title, payload) {
      const [stepName, kind] = String(title || "").split(".");
      if (Object.prototype.hasOwnProperty.call(state.stepSnapshots, stepName)) {
        state.stepSnapshots[stepName] = {
          title,
          kind: kind || "result",
          payload,
          updated_at: new Date().toISOString()
        };
        state.selectedSnapshotStep = stepName;
        renderSnapshotTabs();
        renderSelectedSnapshot();
        return;
      }
      $("snapshot-label").textContent = title || "none";
      const lines = [JSON.stringify(payload, null, 2)];
      $("snapshot-box").innerHTML = `<pre style="white-space:pre-wrap;">${escapeHtml(lines.join("\n"))}</pre>`;
    }

    function renderSnapshotTabs() {
      const tabs = document.querySelectorAll(".json-tab");
      tabs.forEach((tab) => {
        const step = tab.dataset.step;
        const label = tab.dataset.label || step;
        const hasOutput = Boolean(state.stepSnapshots[step]);
        tab.textContent = hasOutput ? `${label} *` : label;
        tab.classList.toggle("active", step === state.selectedSnapshotStep);
      });
    }

    function renderSelectedSnapshot() {
      const step = state.selectedSnapshotStep;
      $("snapshot-label").textContent = step || "none";
      const data = step ? state.stepSnapshots[step] : null;
      if (!data) {
        $("snapshot-box").innerHTML = `<div class="muted">No output for <span class="mono">${escapeHtml(step || "step")}</span> yet.</div>`;
        return;
      }
      const wrapped = {
        step,
        title: data.title,
        kind: data.kind,
        updated_at: data.updated_at,
        data: data.payload
      };
      $("snapshot-box").innerHTML = `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(wrapped, null, 2))}</pre>`;
    }

    function escapeHtml(str) {
      return str
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    function shortText(value, limit = 90) {
      const text = String(value || '').trim();
      if (!text) return '';
      if (text.length <= limit) return text;
      return text.slice(0, limit - 1) + '…';
    }

    function selectedJobId() {
      const fromPipeline = $("job-select") ? $("job-select").value : "";
      const fromAgent = $("agent-job-select") ? $("agent-job-select").value : "";
      return Number(fromPipeline || fromAgent || state.jobId || 0) || null;
    }

    function selectedAgentJobId() {
      const fromAgent = $("agent-job-select") ? $("agent-job-select").value : "";
      return Number(fromAgent || state.jobId || 0) || null;
    }

    function isTestModeEnabled() {
      const toggle = $("test-mode-toggle");
      if (!toggle) return false;
      return Boolean(toggle.checked);
    }

    function setTestMode(enabled) {
      state.testMode = Boolean(enabled);
      const toggle = $("test-mode-toggle");
      if (toggle) toggle.checked = state.testMode;
    }

    function resetPipelineVisuals() {
      $("step-source-meta").textContent = "Profiles: 0";
      $("step-enrich-meta").textContent = "Profiles: 0, Failed: 0";
      $("step-verify-meta").textContent = "Verified: 0, Needs resume: 0, Rejected: 0";
      $("step-add-meta").textContent = "Added: 0";
      $("step-outreach-meta").textContent = "Total: 0, Sent: 0, Pending: 0, Failed: 0";
      setMetrics({ searched: 0, verified: 0, outreached: 0 });
      PIPELINE_STEPS.forEach((step) => setStepStatus(step, "idle"));
      setStepStatus("faq", "manual");
    }

    function resetPipelineMemory() {
      state.sourceProfiles = [];
      state.enrichedProfiles = [];
      state.verifyItems = [];
      state.addedCandidates = [];
      state.outreachItems = [];
      state.stepSnapshots = defaultStepSnapshots();
      state.selectedSnapshotStep = "source";
    }

    function applyStepOutput(step, output) {
      const out = output || {};
      if (step === "source") {
        state.sourceProfiles = out.profiles || [];
        $("step-source-meta").textContent = `Profiles: ${out.total || 0}`;
        setMetrics({ searched: out.total || 0, verified: state.verifyItems.filter(x => x.status === "verified").length, outreached: state.outreachItems.length });
        return;
      }
      if (step === "enrich") {
        state.enrichedProfiles = out.profiles || [];
        $("step-enrich-meta").textContent = `Profiles: ${out.total || 0}, Failed: ${out.failed || 0}`;
        return;
      }
      if (step === "verify") {
        state.verifyItems = out.items || [];
        $("step-verify-meta").textContent = `Verified: ${out.verified || 0}, Needs resume: ${out.needs_resume || 0}, Rejected: ${out.rejected || 0}`;
        if (out.enriched_total != null) {
          $("step-enrich-meta").textContent = `Profiles: ${out.enriched_total || 0}, Failed: ${out.enrich_failed || 0}`;
        }
        renderVerificationExplanations(state.verifyItems);
        setMetrics({
          searched: state.sourceProfiles.length || Number(out.enriched_total || 0),
          verified: out.verified || 0,
          outreached: state.outreachItems.length
        });
        return;
      }
      if (step === "add") {
        state.addedCandidates = out.added || [];
        $("step-add-meta").textContent = `Added: ${out.total || 0}`;
        return;
      }
      if (step === "outreach") {
        state.outreachItems = out.items || [];
        if (out.checked != null || out.connected != null || out.still_waiting != null) {
          $("step-outreach-meta").textContent = `Poll checked: ${out.checked || 0}, connected: ${out.connected || 0}, sent: ${out.sent || 0}, waiting: ${out.still_waiting || 0}, failed: ${out.failed || 0}`;
        } else {
          $("step-outreach-meta").textContent = `Total: ${out.total || 0}, Sent: ${out.sent || 0}, Pending: ${out.pending_connection || 0}, Failed: ${out.failed || 0}`;
        }
        setMetrics({
          searched: state.sourceProfiles.length,
          verified: state.verifyItems.filter(x => x.status === "verified").length,
          outreached: out.total || out.sent || 0
        });
        return;
      }
      if (step === "workflow") {
        $("step-source-meta").textContent = `Profiles: ${out.searched || 0}`;
        $("step-enrich-meta").textContent = `Profiles: ${out.searched || 0}, Failed: 0`;
        $("step-verify-meta").textContent = `Verified: ${out.verified || 0}, Needs resume: ${out.needs_resume || 0}, Rejected: ${out.rejected || 0}`;
        $("step-add-meta").textContent = `Added: ${(out.verified || 0) + (out.needs_resume || 0)}`;
        $("step-outreach-meta").textContent = `Total: ${out.outreached || 0}, Sent: ${out.outreach_sent || 0}, Pending: ${out.outreach_pending_connection || 0}, Failed: ${out.outreach_failed || 0}`;
        setMetrics({ searched: out.searched || 0, verified: out.verified || 0, outreached: out.outreached || 0 });
      }
    }

    async function loadJobProgress(jobId) {
      resetPipelineMemory();
      resetPipelineVisuals();
      renderVerificationExplanations([]);

      if (!jobId) {
        renderSnapshotTabs();
        renderSelectedSnapshot();
        return;
      }

      let data = { items: [] };
      try {
        data = await api(`/api/jobs/${jobId}/progress`);
      } catch {
        renderSnapshotTabs();
        renderSelectedSnapshot();
        return;
      }

      const items = Array.isArray(data.items) ? data.items : [];
      const byStep = {};
      items.forEach((item) => {
        if (item && item.step && !byStep[item.step]) {
          byStep[item.step] = item;
        }
      });

      const stepsInOrder = ["source", "enrich", "verify", "add", "outreach", "workflow"];
      let latestStep = "source";
      let latestUpdated = "";

      stepsInOrder.forEach((step) => {
        const item = byStep[step];
        if (!item) return;
        const status = String(item.status || "idle");
        const payload = item.output_json || {};
        if (Object.prototype.hasOwnProperty.call(state.stepSnapshots, step)) {
          state.stepSnapshots[step] = {
            title: `${step}.restored`,
            kind: status,
            payload,
            updated_at: item.updated_at || null
          };
        }
        if (step !== "workflow") setStepStatus(step, status);
        applyStepOutput(step, payload);
        if (item.updated_at && String(item.updated_at) > latestUpdated) {
          latestUpdated = String(item.updated_at);
          latestStep = step;
        }
      });

      if (latestStep && Object.prototype.hasOwnProperty.call(state.stepSnapshots, latestStep)) {
        state.selectedSnapshotStep = latestStep;
      }
      renderSnapshotTabs();
      renderSelectedSnapshot();
    }

    function setActiveView(view) {
      state.activeView = view === "agent" ? "agent" : "pipeline";
      $("view-tab-pipeline").classList.toggle("active", state.activeView === "pipeline");
      $("view-tab-agent").classList.toggle("active", state.activeView === "agent");
      $("view-pipeline").classList.toggle("active", state.activeView === "pipeline");
      $("view-agent").classList.toggle("active", state.activeView === "agent");
    }

    function setAgentJobMeta(job) {
      if (!job) {
        $("agent-job-title").textContent = "no job selected";
        $("agent-jd-text").value = "";
        return;
      }
      $("agent-job-title").textContent = `#${job.id} ${job.title}`;
      $("agent-jd-text").value = job.jd_text || "";
    }

    function syncJobSelectors() {
      const value = state.jobId ? String(state.jobId) : "";
      if ($("job-select")) $("job-select").value = value;
      if ($("agent-job-select")) $("agent-job-select").value = value;
    }

    async function onSelectedJobChanged(jobId) {
      state.jobId = Number(jobId || 0) || null;
      if (state.jobId) {
        localStorage.setItem(SELECTED_JOB_STORAGE_KEY, String(state.jobId));
      } else {
        localStorage.removeItem(SELECTED_JOB_STORAGE_KEY);
      }
      syncJobSelectors();
      if (!state.jobId) {
        syncJobMeta(null);
        setAgentJobMeta(null);
        await loadJobProgress(null);
        await refreshCandidates();
        await refreshLogs();
        await refreshAgentAccounts();
        return;
      }
      try {
        const job = await api(`/api/jobs/${state.jobId}`);
        syncJobMeta(job);
        setAgentJobMeta(job);
      } catch {
        syncJobMeta(null);
        setAgentJobMeta(null);
      }
      await loadJobProgress(state.jobId);
      await refreshCandidates();
      await refreshLogs();
      await refreshAgentAccounts();
    }

    function openCreateModal() {
      $("create-job-modal").classList.add("open");
      $("create-job-modal").setAttribute("aria-hidden", "false");
    }

    function closeCreateModal() {
      $("create-job-modal").classList.remove("open");
      $("create-job-modal").setAttribute("aria-hidden", "true");
    }

    function resetCreateJobForm() {
      $("job-title").value = DEFAULT_JOB_TEMPLATE.title;
      $("job-location").value = DEFAULT_JOB_TEMPLATE.location;
      $("job-seniority").value = DEFAULT_JOB_TEMPLATE.seniority;
      $("job-languages").value = DEFAULT_JOB_TEMPLATE.preferred_languages;
      $("job-jd").value = DEFAULT_JOB_TEMPLATE.jd_text;
    }

    async function loadJobs() {
      const data = await api('/api/jobs?limit=200');
      const pipelineSelect = $("job-select");
      const agentSelect = $("agent-job-select");
      if (pipelineSelect) pipelineSelect.innerHTML = '';
      if (agentSelect) agentSelect.innerHTML = '';

      if (!data.items || !data.items.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No jobs yet';
        if (pipelineSelect) pipelineSelect.appendChild(opt.cloneNode(true));
        if (agentSelect) agentSelect.appendChild(opt);
        state.jobId = null;
        $("job-label").textContent = 'none';
        $("job-meta").textContent = 'Create a job from modal window to start manual pipeline.';
        setAgentJobMeta(null);
        await refreshAgentAccounts();
        return;
      }

      const rememberedJobId = Number(localStorage.getItem(SELECTED_JOB_STORAGE_KEY) || "0") || null;
      const preferredJobId = state.jobId && data.items.some((x) => Number(x.id) === Number(state.jobId))
        ? Number(state.jobId)
        : (rememberedJobId && data.items.some((x) => Number(x.id) === rememberedJobId))
          ? rememberedJobId
          : Number(data.items[0].id);

      data.items.forEach((job) => {
        const opt = document.createElement('option');
        opt.value = job.id;
        opt.textContent = `#${job.id} ${job.title}`;
        if (pipelineSelect) {
          const clone = opt.cloneNode(true);
          if (Number(job.id) === preferredJobId) clone.selected = true;
          pipelineSelect.appendChild(clone);
        }
        if (agentSelect) {
          if (Number(job.id) === preferredJobId) opt.selected = true;
          agentSelect.appendChild(opt);
        }
      });

      state.jobId = preferredJobId;
      syncJobSelectors();
      const selected = data.items.find((x) => Number(x.id) === state.jobId) || null;
      syncJobMeta(selected);
      setAgentJobMeta(selected);
    }

    function syncJobMeta(job) {
      if (!job) {
        $("job-label").textContent = 'none';
        $("job-meta").textContent = 'Create or select a job to begin.';
        return;
      }
      $("job-label").textContent = `#${job.id}`;
      $("job-meta").textContent = `${job.title} • ${job.seniority || 'auto'} • ${job.location || 'anywhere'}`;
    }

    async function createJob() {
      const title = $("job-title").value.trim();
      const jdText = $("job-jd").value.trim();
      if (!title || !jdText) {
        alert('Title and JD text are required');
        return;
      }

      const payload = {
        title,
        jd_text: jdText,
        location: $("job-location").value.trim() || null,
        seniority: $("job-seniority").value || null,
        preferred_languages: $("job-languages").value
          .split(',')
          .map(x => x.trim().toLowerCase())
          .filter(Boolean)
      };

      const out = await api('/api/jobs', { method: 'POST', body: JSON.stringify(payload) });
      snapshot('job.created', out);
      resetCreateJobForm();
      closeCreateModal();
      await loadJobs();
      await onSelectedJobChanged(state.jobId);
    }

    async function saveAgentJd() {
      const jobId = selectedAgentJobId();
      if (!jobId) return alert('Select a job');
      const jdText = $("agent-jd-text").value.trim();
      if (!jdText) return alert('JD description is required');
      const out = await api(`/api/jobs/${jobId}/jd`, {
        method: 'POST',
        body: JSON.stringify({ jd_text: jdText })
      });
      snapshot('agent.jd_saved', out);
      await loadJobs();
      await onSelectedJobChanged(jobId);
    }

    function renderAgentAccounts() {
      const body = $("agent-accounts-tbody");
      const accounts = state.agentAccounts || [];
      if (!accounts.length) {
        body.innerHTML = '<tr><td colspan="6" class="muted">No active conversations for this job</td></tr>';
        return;
      }
      body.innerHTML = accounts.map((row) => {
        const selected = Number(row.conversation_id) === Number(state.agentConversationId) ? 'row-selected' : '';
        const candidate = escapeHtml(row.candidate_name || `Candidate ${row.candidate_id}`);
        const source = escapeHtml(row.candidate_source || '-');
        const status = escapeHtml(row.pre_resume_status || row.conversation_status || '-');
        const last = escapeHtml(shortText(row.last_message || '-', 100));
        return `
          <tr class="${selected}">
            <td class="mono">${row.conversation_id}</td>
            <td>${candidate}</td>
            <td>${source}</td>
            <td>${status}</td>
            <td>${last}</td>
            <td><button class="agent-open-chat-btn" data-conversation-id="${row.conversation_id}">Open</button></td>
          </tr>
        `;
      }).join('');

      document.querySelectorAll('.agent-open-chat-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const conversationId = Number(btn.dataset.conversationId || '0');
          if (!conversationId) return;
          state.agentConversationId = conversationId;
          renderAgentAccounts();
          await openAgentConversation(conversationId);
        });
      });
    }

    async function refreshAgentAccounts() {
      const jobId = selectedAgentJobId();
      if (!jobId) {
        state.agentAccounts = [];
        state.agentConversationId = null;
        renderAgentAccounts();
        $("agent-chat-title").textContent = "No conversation selected";
        $("agent-chat-messages").innerHTML = '<div class="muted">Select job first.</div>';
        return;
      }
      const out = await api(`/api/chats/overview?limit=300&job_id=${encodeURIComponent(jobId)}`);
      state.agentAccounts = out.items || [];
      if (!state.agentAccounts.some((x) => Number(x.conversation_id) === Number(state.agentConversationId))) {
        state.agentConversationId = null;
      }
      renderAgentAccounts();
      if (state.agentConversationId) {
        await openAgentConversation(state.agentConversationId);
      }
    }

    async function openAgentConversation(conversationId) {
      if (!conversationId) return;
      const out = await api(`/api/conversations/${conversationId}/messages`);
      const convo = out.conversation || {};
      const account = (state.agentAccounts || []).find((x) => Number(x.conversation_id) === Number(conversationId));
      const title = account
        ? `${account.candidate_name || 'Candidate'} • #${conversationId}`
        : `Conversation #${conversationId}`;
      $("agent-chat-title").textContent = title;
      const items = out.items || [];
      if (!items.length) {
        $("agent-chat-messages").innerHTML = '<div class="muted">No messages yet</div>';
        return;
      }
      $("agent-chat-messages").innerHTML = items.map((msg) => {
        const direction = escapeHtml(msg.direction || '-');
        const kind = direction === 'inbound' ? 'inbound' : 'outbound';
        const created = escapeHtml(msg.created_at || '');
        const content = escapeHtml(msg.content || '');
        return `
          <div class="chat-msg ${kind}">
            <div style="display:flex;justify-content:space-between;gap:8px;">
              <b>${direction}</b>
              <span class="mono muted">${created}</span>
            </div>
            <div style="margin-top:6px;white-space:pre-wrap;">${content}</div>
          </div>
        `;
      }).join('');
      state.agentConversationId = Number(conversationId);
      if (convo && convo.job_id && Number(convo.job_id) !== Number(state.jobId)) {
        await onSelectedJobChanged(Number(convo.job_id));
      }
    }

    async function addManualAgentAccount() {
      const jobId = selectedAgentJobId();
      if (!jobId) return alert('Select a job');
      const fullName = $("agent-manual-name").value.trim();
      if (!fullName) return alert('Candidate name is required');
      const payload = {
        job_id: jobId,
        full_name: fullName,
        language: $("agent-manual-language").value.trim() || "en",
        linkedin_id: $("agent-manual-linkedin-id").value.trim() || null,
        external_chat_id: $("agent-manual-chat-id").value.trim() || null,
        scope_summary: $("agent-jd-text").value.trim() || null,
      };
      const out = await api('/api/agent/accounts/manual', {
        method: 'POST',
        body: JSON.stringify(payload)
      });
      snapshot('agent.account_added', out);
      $("agent-manual-name").value = '';
      $("agent-manual-linkedin-id").value = '';
      $("agent-manual-chat-id").value = '';
      state.agentConversationId = Number(out.conversation_id);
      await refreshAgentAccounts();
      await openAgentConversation(state.agentConversationId);
      await refreshCandidates();
      await refreshLogs();
    }

    async function sendAgentInboundMessage() {
      const conversationId = Number(state.agentConversationId || 0);
      if (!conversationId) return alert('Open conversation first');
      const text = $("agent-inbound-input").value.trim();
      if (!text) return alert('Message is required');
      const out = await api(`/api/conversations/${conversationId}/inbound`, {
        method: 'POST',
        body: JSON.stringify({ message: text }),
      });
      snapshot('agent.inbound', out);
      $("agent-inbound-input").value = '';
      await openAgentConversation(conversationId);
      await refreshAgentAccounts();
      await refreshCandidates();
      await refreshLogs();
    }

    function renderVerificationExplanations(items) {
      const box = $("verify-explanations-box");
      if (!items || !items.length) {
        box.innerHTML = '<div class="muted">Run Verify to see human-readable decision reasons.</div>';
        return;
      }

      const prioritized = [
        ...items.filter(x => x.status === 'needs_resume'),
        ...items.filter(x => x.status === 'rejected'),
        ...items.filter(x => x.status !== 'rejected' && x.status !== 'needs_resume')
      ].slice(0, 12);

      box.innerHTML = prioritized.map((x) => {
        const profile = x.profile || {};
        const name = escapeHtml(profile.full_name || profile.name || 'Unknown');
        const score = typeof x.score === 'number' ? x.score.toFixed(3) : escapeHtml(String(x.score ?? '-'));
        const status = escapeHtml(String(x.status || '-'));
        const explanation = escapeHtml(
          (x.notes && x.notes.human_explanation)
            || 'No explanation generated by rules engine.'
        );
        return `
          <div class="verify-item">
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
              <div><b>${name}</b> <span class="mono muted">score ${score}</span></div>
              <span class="pill ${status}">${status}</span>
            </div>
            <div class="muted" style="margin-top:6px;">${explanation}</div>
          </div>
        `;
      }).join('');
    }

    async function runSource() {
      const jobId = selectedJobId();
      if (!jobId) return alert('Select a job');
      setStepStatus('source', 'running');
      try {
        const limit = Number($("source-limit").value || '10');
        const out = await api('/api/steps/source', {
          method: 'POST',
          body: JSON.stringify({ job_id: jobId, limit, test_mode: isTestModeEnabled() })
        });
        state.sourceProfiles = out.profiles || [];
        state.enrichedProfiles = [];
        state.verifyItems = [];
        state.addedCandidates = [];
        state.outreachItems = [];
        $("step-source-meta").textContent = `Profiles: ${out.total || 0}`;
        $("step-enrich-meta").textContent = "Profiles: 0, Failed: 0";
        $("step-verify-meta").textContent = "Verified: 0, Needs resume: 0, Rejected: 0";
        $("step-add-meta").textContent = "Added: 0";
        $("step-outreach-meta").textContent = "Total: 0, Sent: 0, Pending: 0, Failed: 0";
        setStepStatus('enrich', 'idle');
        setStepStatus('verify', 'idle');
        setStepStatus('add', 'idle');
        setStepStatus('outreach', 'idle');
        renderVerificationExplanations([]);
        setMetrics({ searched: out.total || 0, verified: 0, outreached: 0 });
        setStepStatus('source', 'success');
        snapshot('source.result', out);
      } catch (e) {
        setStepStatus('source', 'error');
        snapshot('source.error', { error: e.message });
      }
      await refreshLogs();
    }

    async function runEnrich() {
      const jobId = selectedJobId();
      if (!jobId) return alert('Select a job');
      if (!state.sourceProfiles.length) return alert('Run Source first');
      setStepStatus('enrich', 'running');
      try {
        const out = await api('/api/steps/enrich', {
          method: 'POST',
          body: JSON.stringify({ job_id: jobId, profiles: state.sourceProfiles })
        });
        state.enrichedProfiles = out.profiles || [];
        state.verifyItems = [];
        state.addedCandidates = [];
        state.outreachItems = [];
        $("step-enrich-meta").textContent = `Profiles: ${out.total || 0}, Failed: ${out.failed || 0}`;
        $("step-verify-meta").textContent = "Verified: 0, Needs resume: 0, Rejected: 0";
        $("step-add-meta").textContent = "Added: 0";
        $("step-outreach-meta").textContent = "Total: 0, Sent: 0, Pending: 0, Failed: 0";
        setStepStatus('verify', 'idle');
        setStepStatus('add', 'idle');
        setStepStatus('outreach', 'idle');
        renderVerificationExplanations([]);
        setMetrics({ searched: state.sourceProfiles.length, verified: 0, outreached: 0 });
        setStepStatus('enrich', 'success');
        snapshot('enrich.result', out);
      } catch (e) {
        setStepStatus('enrich', 'error');
        snapshot('enrich.error', { error: e.message });
      }
      await refreshLogs();
    }

    async function runVerify() {
      const jobId = selectedJobId();
      if (!jobId) return alert('Select a job');
      if (!state.sourceProfiles.length) return alert('Run Source first');
      if (!state.enrichedProfiles.length) return alert('Run Enrich first');
      setStepStatus('verify', 'running');
      try {
        const out = await api('/api/steps/verify', {
          method: 'POST',
          body: JSON.stringify({ job_id: jobId, profiles: state.enrichedProfiles })
        });
        state.verifyItems = out.items || [];
        $("step-verify-meta").textContent = `Verified: ${out.verified || 0}, Needs resume: ${out.needs_resume || 0}, Rejected: ${out.rejected || 0}`;
        $("step-enrich-meta").textContent = `Profiles: ${out.enriched_total || state.enrichedProfiles.length}, Failed: ${out.enrich_failed || 0}`;
        renderVerificationExplanations(state.verifyItems);
        setMetrics({ searched: state.sourceProfiles.length, verified: out.verified || 0, outreached: state.outreachItems.length });
        setStepStatus('verify', 'success');
        snapshot('verify.result', out);
      } catch (e) {
        setStepStatus('verify', 'error');
        snapshot('verify.error', { error: e.message });
      }
      await refreshLogs();
    }

    async function runAdd() {
      const jobId = selectedJobId();
      if (!jobId) return alert('Select a job');
      const screeningItems = state.verifyItems.filter(x => x.status !== 'rejected');
      if (!screeningItems.length) return alert('No screening candidates. Run Verify first.');

      setStepStatus('add', 'running');
      try {
        const out = await api('/api/steps/add', {
          method: 'POST',
          body: JSON.stringify({ job_id: jobId, verified_items: screeningItems })
        });
        state.addedCandidates = out.added || [];
        $("step-add-meta").textContent = `Added: ${out.total || 0}`;
        setStepStatus('add', 'success');
        snapshot('add.result', out);
      } catch (e) {
        setStepStatus('add', 'error');
        snapshot('add.error', { error: e.message });
      }
      await refreshCandidates();
      await refreshLogs();
    }

    async function runOutreach() {
      const jobId = selectedJobId();
      if (!jobId) return alert('Select a job');
      let candidateIds = state.addedCandidates.map(x => x.candidate_id);
      if (!candidateIds.length) {
        try {
          const dbRows = await api(`/api/jobs/${jobId}/candidates`);
          candidateIds = (dbRows.items || [])
            .filter((x) => !['rejected', 'resume_received'].includes(String(x.status || '').toLowerCase()))
            .map((x) => Number(x.candidate_id))
            .filter((x) => Number.isFinite(x) && x > 0);
        } catch {
          candidateIds = [];
        }
      }
      if (!candidateIds.length) return alert('No eligible candidates for outreach. Run Add first.');

      setStepStatus('outreach', 'running');
      try {
        const out = await api('/api/steps/outreach', {
          method: 'POST',
          body: JSON.stringify({
            job_id: jobId,
            candidate_ids: candidateIds,
            test_mode: isTestModeEnabled()
          })
        });
        state.outreachItems = out.items || [];
        $("step-outreach-meta").textContent = `Total: ${out.total || 0}, Sent: ${out.sent || 0}, Pending: ${out.pending_connection || 0}, Failed: ${out.failed || 0}`;
        setMetrics({ searched: state.sourceProfiles.length, verified: state.verifyItems.filter(x => x.status === 'verified').length, outreached: out.total || 0 });
        if ((out.failed || 0) > 0 && (out.sent || 0) === 0 && (out.pending_connection || 0) === 0) {
          setStepStatus('outreach', 'error');
        } else {
          setStepStatus('outreach', 'success');
        }
        snapshot('outreach.result', out);
      } catch (e) {
        setStepStatus('outreach', 'error');
        snapshot('outreach.error', { error: e.message });
      }
      await refreshCandidates();
      await refreshLogs();
    }

    async function runOutreachPollConnections() {
      const jobId = selectedJobId();
      if (!jobId) return alert('Select a job');
      setStepStatus('outreach', 'running');
      try {
        const out = await api('/api/outreach/poll-connections', {
          method: 'POST',
          body: JSON.stringify({ job_id: jobId, limit: 200 })
        });
        $("step-outreach-meta").textContent = `Poll checked: ${out.checked || 0}, connected: ${out.connected || 0}, sent: ${out.sent || 0}, waiting: ${out.still_waiting || 0}, failed: ${out.failed || 0}`;
        if ((out.failed || 0) > 0 && (out.sent || 0) === 0) {
          setStepStatus('outreach', 'error');
        } else {
          setStepStatus('outreach', 'success');
        }
        snapshot('outreach.poll_connections', out);
      } catch (e) {
        setStepStatus('outreach', 'error');
        snapshot('outreach.poll_error', { error: e.message });
      }
      await refreshCandidates();
      await refreshAgentAccounts();
      await refreshLogs();
    }

    async function runFull() {
      const jobId = selectedJobId();
      if (!jobId) return alert('Select a job');
      ['source', 'enrich', 'verify', 'add', 'outreach'].forEach(s => setStepStatus(s, 'running'));

      try {
        const limit = Number($("source-limit").value || '10');
        const out = await api('/api/workflows/execute', {
          method: 'POST',
          body: JSON.stringify({ job_id: jobId, limit, test_mode: isTestModeEnabled() })
        });

        $("step-source-meta").textContent = `Profiles: ${out.searched || 0}`;
        $("step-enrich-meta").textContent = `Profiles: ${out.searched || 0}, Failed: 0`;
        $("step-verify-meta").textContent = `Verified: ${out.verified || 0}, Needs resume: ${out.needs_resume || 0}, Rejected: ${out.rejected || 0}`;
        $("step-add-meta").textContent = `Added: ${(out.verified || 0) + (out.needs_resume || 0)}`;
        $("step-outreach-meta").textContent = `Total: ${out.outreached || 0}, Sent: ${out.outreach_sent || 0}, Pending: ${out.outreach_pending_connection || 0}, Failed: ${out.outreach_failed || 0}`;

        ['source', 'enrich', 'verify', 'add'].forEach(s => setStepStatus(s, 'success'));
        if ((out.outreach_failed || 0) > 0 && (out.outreach_sent || 0) === 0 && (out.outreach_pending_connection || 0) === 0) {
          setStepStatus('outreach', 'error');
        } else {
          setStepStatus('outreach', 'success');
        }
        setMetrics({ searched: out.searched || 0, verified: out.verified || 0, outreached: out.outreached || 0 });
        snapshot('workflow.execute', out);
      } catch (e) {
        ['source', 'enrich', 'verify', 'add', 'outreach'].forEach(s => setStepStatus(s, 'error'));
        snapshot('workflow.error', { error: e.message });
      }
      await refreshCandidates();
      await refreshLogs();
    }

    async function refreshLogs() {
      const limit = Number($("logs-limit").value || '60');
      try {
        const data = await api(`/api/logs?limit=${encodeURIComponent(limit)}`);
        const box = $("logs-box");
        const rows = data.items || [];
        if (!rows.length) {
          box.innerHTML = '<div class="muted">No logs yet</div>';
          return;
        }

        box.innerHTML = rows.map((item) => {
          const details = escapeHtml(JSON.stringify(item.details || {}));
          return `
            <div class="log-row">
              <div><b>${escapeHtml(item.operation)}</b> <span class="mono muted">${escapeHtml(item.created_at)}</span></div>
              <div class="muted">entity: ${escapeHtml(item.entity_type || '-')}:${escapeHtml(item.entity_id || '-')} • status: ${escapeHtml(item.status || '-')}</div>
              <div class="mono muted">${details}</div>
            </div>
          `;
        }).join('');
      } catch (e) {
        $("logs-box").innerHTML = `<div class="muted">Failed to load logs: ${escapeHtml(e.message)}</div>`;
      }
    }

    async function refreshCandidates() {
      const jobId = selectedJobId();
      const body = $("candidates-tbody");
      body.innerHTML = '';
      if (!jobId) {
        body.innerHTML = '<tr><td colspan="6" class="muted">Select job</td></tr>';
        return;
      }

      try {
        const data = await api(`/api/jobs/${jobId}/candidates`);
        const items = data.items || [];
        if (!items.length) {
          body.innerHTML = '<tr><td colspan="6" class="muted">No candidates yet</td></tr>';
          return;
        }

        body.innerHTML = items.map((x) => {
          const skills = (x.skills || []).slice(0, 6).join(', ');
          return `
            <tr>
              <td class="mono">${x.candidate_id}</td>
              <td>${escapeHtml(x.full_name || '-')}</td>
              <td>${escapeHtml(x.status || '-')}</td>
              <td class="mono">${x.score ?? '-'}</td>
              <td>${escapeHtml(x.location || '-')}</td>
              <td>${escapeHtml(skills || '-')}</td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        body.innerHTML = `<tr><td colspan="6" class="muted">Failed: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    async function fullRefresh() {
      await loadJobs();
      await onSelectedJobChanged(state.jobId);
    }

    function bindEvents() {
      $("view-tab-pipeline").addEventListener('click', () => setActiveView('pipeline'));
      $("view-tab-agent").addEventListener('click', () => setActiveView('agent'));
      $("create-job-btn").addEventListener('click', () => createJob().catch(e => alert(e.message)));
      $("open-create-modal-btn").addEventListener('click', () => openCreateModal());
      $("close-create-modal-btn").addEventListener('click', () => closeCreateModal());
      $("create-job-modal-backdrop").addEventListener('click', () => closeCreateModal());
      $("run-source-btn").addEventListener('click', () => runSource());
      $("run-enrich-btn").addEventListener('click', () => runEnrich());
      $("run-verify-btn").addEventListener('click', () => runVerify());
      $("run-add-btn").addEventListener('click', () => runAdd());
      $("run-outreach-btn").addEventListener('click', () => runOutreach());
      $("poll-connections-btn").addEventListener('click', () => runOutreachPollConnections());
      $("run-full-btn").addEventListener('click', () => runFull());
      $("refresh-btn").addEventListener('click', () => fullRefresh());
      $("logs-refresh-btn").addEventListener('click', () => refreshLogs());
      $("cands-refresh-btn").addEventListener('click', () => refreshCandidates());
      $("agent-save-jd-btn").addEventListener('click', () => saveAgentJd().catch(e => alert(e.message)));
      $("agent-refresh-accounts-btn").addEventListener('click', () => refreshAgentAccounts().catch(e => alert(e.message)));
      $("agent-add-manual-btn").addEventListener('click', () => addManualAgentAccount().catch(e => alert(e.message)));
      $("agent-send-inbound-btn").addEventListener('click', () => sendAgentInboundMessage().catch(e => alert(e.message)));
      $("agent-refresh-chat-btn").addEventListener('click', () => {
        if (!state.agentConversationId) return;
        openAgentConversation(state.agentConversationId).catch(e => alert(e.message));
      });
      document.querySelectorAll(".json-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          state.selectedSnapshotStep = tab.dataset.step || "source";
          renderSnapshotTabs();
          renderSelectedSnapshot();
        });
      });

      $("job-select").addEventListener('change', async (e) => {
        await onSelectedJobChanged(Number(e.target.value || '0') || null);
      });

      $("agent-job-select").addEventListener('change', async (e) => {
        await onSelectedJobChanged(Number(e.target.value || '0') || null);
      });
      $("test-mode-toggle").addEventListener('change', () => {
        const enabled = isTestModeEnabled();
        state.testMode = enabled;
        localStorage.setItem(TEST_MODE_STORAGE_KEY, enabled ? "1" : "0");
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') closeCreateModal();
      });
    }

    bindEvents();
    resetCreateJobForm();
    setTestMode((localStorage.getItem(TEST_MODE_STORAGE_KEY) || "1") !== "0");
    renderSnapshotTabs();
    renderSelectedSnapshot();
    fullRefresh();
  </script>
</body>
</html>
